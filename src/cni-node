#!/bin/sh

set -e

USAGE=$(cat <<EOF
Usage: cni-node <Command> [Options]

Commands
    install    install according to the options
    uninstall  uninstall according to the options

    list       list available CNI plugins
    version    show version

Options
    --plugins=<Plugins>      Comma separated CNI plugins
    --configs=<Configs>      CNI configuration templates
    --manifests=<Manifests>  Kubernetes manifest templates
    --wait                   Wait for SIGTERM or SIGINT after install/uninstall
EOF
)

function main {
    case "$1" in
        install|uninstall)
            local ACTION="$1"
            local WAIT=false
            shift

            for ARG in "$@"; do
                case "${ARG}" in
                    --plugins=*) local PLUGINS="${ARG#*=}"; shift ;;
                    --configs=*) local CONFIGS="${ARG#*=}"; shift ;;
                    --manifests=*) local MANIFESTS="${ARG#*=}"; shift ;;
                    --wait) WAIT=true; shift ;;
                    *=*) >&2 echo "Unknown argument: ${ARG%=*}"; exit 2 ;;
                    *) >&2 echo "Unknown argument: ${ARG}"; exit 2 ;;
                esac
            done

            [ -n "${PLUGINS}" ] && "${ACTION}_plugins" "${PLUGINS/,/ }"
            [ -n "${CONFIGS}" ] && "${ACTION}_configs" "${CONFIGS/,/ }";
            [ -n "${MANIFESTS}" ] && "${ACTION}_manifests" "${MANIFESTS/,/ }";

            "${WAIT}" && wait
        ;;
        list) ls -1 /opt/cni/bin ;;
        version) cat /version ;;
        *) usage ;;
    esac
}

function install_plugins {
    local PLUGINS=$*

    for PLUGIN in ${PLUGINS}; do
        echo "Installing CNI plugin ${PLUGIN}..."
        install "/opt/cni/bin/${PLUGIN}" "/host/opt/cni/bin/${PLUGIN}"
    done
    [ -n "${PLUGINS}" ] && echo "Done."
}
function install_configs {
    local CONFIGS=$*

    for CONFIG in ${CONFIGS}; do
        echo "Installing CNI configuration from $(basename "${CONFIG}")..."

        local SED_ARGS; SED_ARGS="$(sed_args "${CONFIG}")"
        if [ -n "${SED_ARGS}" ]; then
            sed ${SED_ARGS} "${CONFIG}" | tee "/host/${CONFIG}" > /dev/null
        else
            cp "${CONFIG}" "/host/${CONFIG}"
        fi

        echo "### ${CONFIG} ###"
        cat "/host/${CONFIG}"
        echo "###"
    done
}
function install_manifests {
    local MANIFESTS=$*

    for MANIFEST in ${MANIFESTS}; do
        echo "Creating Kubernetes object from ${MANIFEST}..."
        envsubst < "${MANIFEST}" | kubectl delete --filename -

        echo "### ${MANIFEST} ###"
        envsubst < "${MANIFEST}"
        echo "###"
    done
}

function uninstall_plugins {
    local PLUGINS=$*

    for PLUGIN in ${PLUGINS}; do
        echo "Uninstalling CNI plugin ${PLUGIN}..."
        rm -f "/host/opt/cni/bin/${PLUGIN}"
    done
    echo "Done."
}
function uninstall_configs {
    local CONFIGS=$*

    for CONFIG in ${CONFIGS}; do
        echo "Ununstalling CNI configuration $(basename "${CONFIG}")..."
        rm -f "${CONFIG}"
    done
}
function uninstall_manifests {
    local MANIFESTS=$*

    for MANIFEST in ${MANIFESTS}; do
        echo "Deleting Kubernetes object from ${MANIFEST}..."
        envsubst < "${MANIFEST}" | kubectl delete --filename -
    done
}

function kubectl {
    local SERVICE_ACCOUNT="/var/run/secrets/kubernetes.io/serviceaccount"
    local CACERT="${SERVICE_ACCOUNT}/ca.crt"
    local TOKEN; TOKEN="$(cat "${SERVICE_ACCOUNT}/token")"

    kubectl --token "${TOKEN}" --certificate-authority "${CACERT}" "$@"
}

function sed_args {
    local TEMPLATE="$1"

    for POINTER in $(template_pointers "${TEMPLATE}"); do
        printf %b " -e /__${POINTER}__/r/host/etc/cni/net.d/${POINTER}" \
                  " -e /__${POINTER}__/d"
    done
}

function template_pointers {
    local TEMPLATE="$1"
    grep -o "__\\(.*\\)__" "${TEMPLATE}" | sed "s/__\\(.*\\)__/\\1/"
}

function wait {
    echo "Waiting for SIGTERM or SIGINT..."
    trap stop SIGTERM SIGINT
    while :; do
        sleep 1
    done
}
function stop {
    echo "Done."
    exit 0
}

function usage {
    >&2 echo "${USAGE}"
    exit 2
}

main "$@"
